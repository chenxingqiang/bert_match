#!/usr/bin/env bash
# pull dockers
docker pull tensorflow/serving:1.15.0
# distribute tf-serving
docker run -p 8501:8501 --name bert_server --mount type=bind,source=/dwdata/home/xingqiangchen/_recall_bert/bert_server/online/,target=/models/bert_server -e  MODEL_NAME=bert_server -itd tensorflow/serving:1.15.0
# test serving
curl -d '{"inputs":{"masked_lm_positions":[48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"masked_lm_ids":[182535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"masked_lm_weights":[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"input_mask":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"input_ids":[182535,182535,182535,182535,182535,182535,1991,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,700,700,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,1991,182535,182535,182535,1991,182535,182535,182535,182535,182535,182535,629886,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}' -X POST http://10.0.22.244:8501/v1/models/bert_server:predic
# test serving with RT
curl -o curl.log -s -w 'time_namelookup: %{time_namelookup}\ntime_connect: %{time_connect}\ntime_starttransfer: %{time_starttransfer}\ntime_total: %{time_total}\n' -d '{"inputs":{"masked_lm_positions":[[48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"info":[[777800]],"masked_lm_ids":[[182535,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"masked_lm_weights":[[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"input_mask":[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"input_ids":[[182535,182535,182535,182535,182535,182535,1991,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,700,700,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,182535,1991,182535,182535,182535,1991,182535,182535,182535,182535,182535,182535,629886,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}}' -X POST http://10.0.22.244:8501/v1/models/bert_server:predict